<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8">
<title>GESHER – לוח חודשי</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --accent: #2563eb;
    --muted: #94a3b8;
    --event: #334155;
    --text: #ffffff;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 18px;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  .top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
  }
  h1 { margin: 0; font-size: 36px; }
  #clock {
    background: #fff;
    color: #000;
    padding: 6px 14px;
    border-radius: 10px;
    font-weight: 600;
  }

  .nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
  }

  .nav .btn {
    background: var(--card);
    color: var(--text);
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 20px;
  }
  .monthTitle {
    font-size: 24px;
    font-weight: 700;
  }

  .weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    text-align: center;
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }

  .day {
    background: var(--card);
    border-radius: 10px;
    padding: 10px;
    min-height: 200px; /* увеличенная высота */
    display: flex;
    flex-direction: column;
    align-items: stretch;
    overflow: auto;
    font-size: 14px;
  }
  .day h2 {
    margin: 0 0 4px 0;
    font-size: 18px;
    color: var(--muted);
  }
  .today {
    background: var(--accent);
  }
  .event {
    margin-top: 6px;
    padding: 6px;
    background: var(--event);
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.15;
    word-break: break-word;
  }
  .ev-time {
    color: #9be7ff;
    font-weight: 600;
  }

  @media (min-width: 1200px){
    .day { min-height: 220px; font-size: 16px; }
    .event { font-size: 15px; }
  }
</style>
</head>
<body>

<div class="top">
  <h1>לוח הצגות</h1>
  <div id="clock">--:--:--</div>
</div>

<div class="nav">
  <button class="btn" id="prevBtn">חודש קודם</button>
  <div class="monthTitle" id="monthTitle">—</div>
  <button class="btn" id="nextBtn">חודש הבא</button>
</div>

<div class="weekdays">
  <div>א׳</div><div>ב׳</div><div>ג׳</div><div>ד׳</div><div>ה׳</div><div>ו׳</div><div>ש׳</div>
</div>

<div id="calendar" class="calendar"></div>

<script>
// === НАСТРОЙКИ ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8VHJ7usLuV213YvhCULcjqMrH6M22QQ_cLDtP8f6u0cb7XXKbeBVzEoKRGmigGFm_EQvtN17sQGi2/pub?gid=0&single=true&output=csv";

// стартовый месяц — текущий
let viewDate = new Date();

// --- Clock ---
function updateClock(){
  const now = new Date();
  const options = { timeZone:"Asia/Jerusalem", hour:"2-digit", minute:"2-digit", second:"2-digit" };
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("he-IL", options).format(now);
}
setInterval(updateClock, 1000);
updateClock();

// --- CSV parsing util ---
function parseCSV(text){
  const rows = [];
  let cur = "", row = [], inside = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], nxt = text[i+1];
    if (ch === '"' && inside && nxt === '"') { cur += '"'; i++; continue; }
    if (ch === '"') { inside = !inside; continue; }
    if (ch === ',' && !inside) { row.push(cur); cur = ""; continue; }
    if ((ch === '\n' || ch === '\r') && !inside) {
      if (cur !== "" || row.length>0) { row.push(cur); rows.push(row); row = []; cur=""; }
      continue;
    }
    cur += ch;
  }
  if (cur !== "" || row.length>0) rows.push(row);
  return rows;
}

// find column indices by header (Hebrew or English)
function detectCols(header){
  const h = header.map(c => (c||"").trim().toLowerCase());
  return {
    date:    h.indexOf("תאריך")   >=0? h.indexOf("תאריך")   : h.indexOf("date"),
    title:   h.indexOf("שם ההצגה")>=0? h.indexOf("שם ההצגה") : h.indexOf("title"),
    time:    h.indexOf("שעה")     >=0? h.indexOf("שעה")     : h.indexOf("time"),
    place:   h.indexOf("מקום")    >=0? h.indexOf("מקום")    : h.indexOf("place"),
    note:    h.indexOf("הערה")    >=0? h.indexOf("הערה")    : h.indexOf("note"),
    constraints: h.indexOf("אילוצים")>=0? h.indexOf("אילוצים") : -1
  };
}

// normalize date strings to YYYY-MM-DD
function normalizeDate(s){
  if(!s) return null;
  s = String(s).trim();
  if(!s) return null;
  // already ISO?
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  // dd.mm(.yyyy) or dd/mm(/yyyy)
  let parts = null;
  if (s.includes(".")) parts = s.split(".");
  else if (s.includes("/")) parts = s.split("/");
  if (!parts || parts.length < 2) return null;
  let d = String(Number(parts[0])).padStart(2,"0");
  let m = String(Number(parts[1])).padStart(2,"0");
  let y = (parts.length >=3 && parts[2].trim() !== "") ? parts[2].trim() : viewDate.getFullYear();
  if (y.length === 2) y = "20" + y;
  return `${y}-${m}-${d}`;
}

// load events from CSV
async function loadEvents(){
  const resp = await fetch(CSV_URL, {cache:"no-store"});
  const txt = await resp.text();
  const rows = parseCSV(txt);
  if (!rows || rows.length < 2) return [];
  const cols = detectCols(rows[0]);
  const events = [];
  for (let i=1; i<rows.length; i++){
    const r = rows[i];
    if (!r[cols.date] || !r[cols.title]) continue;
    const dt = normalizeDate(r[cols.date]);
    if (!dt) continue;
    events.push({
      date: dt,
      title: r[cols.title].trim(),
      time: r[cols.time]  ? r[cols.time].trim()  : "",
      place:r[cols.place] ? r[cols.place].trim() : "",
      note: r[cols.note]  ? r[cols.note].trim()  : "",
      constraints: (cols.constraints>=0 && r[cols.constraints]) ? r[cols.constraints].trim() : ""
    });
  }
  return events;
}

// build calendar for one month
function buildMonth(year, month, events){
  const first = new Date(year, month, 1);
  const startDay = first.getDay(); // 0=Sunday
  const daysCount = new Date(year, month+1, 0).getDate();

  const cal = document.getElementById("calendar");
  cal.innerHTML = "";

  // blanks
  for (let i=0; i<startDay; i++){
    cal.appendChild(document.createElement("div"));
  }

  for (let d=1; d<=daysCount; d++){
    const dd = String(d).padStart(2,"0");
    const mm = String(month+1).padStart(2,"0");
    const yyyy = year;
    const full = `${yyyy}-${mm}-${dd}`;

    const cell = document.createElement("div");
    cell.className = "day";

    const hd = document.createElement("h2");
    hd.textContent = d;
    cell.appendChild(hd);

    const todays = events.filter(ev => ev.date === full);
    todays.forEach(ev=>{
      const evDiv = document.createElement("div");
      evDiv.className = "event";
      let html = "";
      if (ev.time) html += `<span class="ev-time">${ev.time}</span> `;
      html += `<b>${escapeHtml(ev.title)}</b>`;
      if (ev.place) html += `<div>${escapeHtml(ev.place)}</div>`;
      if (ev.note) html += `<div style="opacity:.85;font-size:12px;">${escapeHtml(ev.note)}</div>`;
      if (ev.constraints) html += `<div style="opacity:.75;font-size:12px;">אילוצים: ${escapeHtml(ev.constraints)}</div>`;
      evDiv.innerHTML = html;
      cell.appendChild(evDiv);
    });

    // highlight today
    const now = new Date();
    if (yyyy === now.getFullYear() && month === now.getMonth() && d === now.getDate()){
      cell.classList.add("today");
    }

    cal.appendChild(cell);
  }
}

// escape html
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// render for current viewDate month
async function render(){
  const ev = await loadEvents();
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();

  // month name in Hebrew + year
  const monthName = viewDate.toLocaleDateString("he-IL", { month:"long", year:"numeric" });
  document.getElementById("monthTitle").textContent = monthName;

  buildMonth(year, month, ev);
}

// buttons
document.getElementById("prevBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); render(); };
document.getElementById("nextBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); render(); };

// initial
render();
setInterval(render, 30000);
</script>
</body>
</html>
