<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="UTF-8">
<title>לוח הצגות - GESHER</title>

<style>
body{
    background: rgb(1, 67, 43);
    color: white;
    font-family: Arial;
    margin: 0;
    padding: 30px;
}

.header-bar{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

h1{
    font-size: 60px;
    margin: 0;
}

#clock {
    font-size: 34px;
    background:#111;
    padding: 12px 25px;
    border-radius: 10px;
}

.table-wrapper{
    max-height: 75vh;
    overflow-y: auto;
    border: 2px solid #222;
}

table{
    width: 100%;
    border-collapse: collapse;
    font-size: 30px;
    text-align: center;
}

thead th{
    position: sticky;
    top: 0;
    background:#111;
    padding: 20px;
    border-bottom: 2px solid #777;
}

td{
    padding: 18px;
    border-bottom: 1px solid #333;
}

tr:nth-child(even){
    background:#0c0c0c;
}

.date{ width: 15%; }
.time{ width: 15%; }
.title{ width: 30%; }
.place{ width: 25%; }
.note{ width: 15%; }
</style>
</head>

<body>

<div class="header-bar">
    <h1>לוח הצגות</h1>
    <div id="clock">--:--</div>
</div>

<div class="table-wrapper">
    <table id="schedule">
        <thead>
        <tr>
            <th>תאריך</th>
            <th>שעה</th>
            <th>שם ההצגה</th>
            <th>מקום</th>
            <th>הערות</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8VHJ7usLuV213YvhCULcjqMrH6M22QQ_cLDtP8f6u0cb7XXKbeBVzEoKRGmigGFm_EQvtN17sQGi2/pub?gid=1245589780&single=true&output=csv"

function getTelAvivTime(){
    const now = new Date();
    const options = {
        timeZone: "Asia/Jerusalem",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
    }
    return new Intl.DateTimeFormat("he-IL", options).format(now);
}

function updateClock(){
    document.getElementById("clock").textContent = getTelAvivTime();
}

setInterval(updateClock, 1000);
updateClock();

// Простейший CSV парсер (лучше твоего split)
function parseCSV(text) {
    const rows = [];
    let current = '';
    let row = [];
    let insideQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '"' && text[i + 1] === '"') {
            current += '"';
            i++;
        } else if (char === '"') {
            insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
            row.push(current);
            current = '';
        } else if (char === '\n' && !insideQuotes) {
            row.push(current);
            rows.push(row);
            row = [];
            current = '';
        } else {
            current += char;
        }
    }

    if (current.length > 0) {
        row.push(current);
        rows.push(row);
    }

    return rows;
}

function isTodayOrFuture(dateStr){
    // ожидается формат: DD.MM.YYYY
    const parts = dateStr.split(".");
    if(parts.length < 3) return false;

    const day = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const year = parseInt(parts[2]);

    const showDate = new Date(year, month, day);

    const now = new Date();
    const telAvivNow = new Date(
        now.toLocaleString("en-US", { timeZone: "Asia/Jerusalem" })
    );

    telAvivNow.setHours(0,0,0,0);
    showDate.setHours(0,0,0,0);

    return showDate >= telAvivNow;
}

async function loadSchedule() {
    const response = await fetch(CSV_URL);
    const data = await response.text();

    const rows = parseCSV(data);
    const body = document.querySelector("#schedule tbody");

    body.innerHTML = "";

    const classes = ["date","time","title","place","note"];

    for(let i = 1; i < rows.length; i++){
        const rowData = rows[i];

        if(rowData.length < 5) continue;

        if(!isTodayOrFuture(rowData[0])) continue;

        const row = document.createElement("tr");

        rowData.forEach((cell, index) => {
            const td = document.createElement("td");
            td.className = classes[index] || "";
            td.textContent = cell.replace(/"/g, "");
            row.appendChild(td);
        });

        body.appendChild(row);
    }
}

loadSchedule();
setInterval(loadSchedule