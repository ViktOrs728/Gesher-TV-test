<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Theatre GESHER </title>

<style>
body {
  font-family: system-ui, Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #034920;
  color: #f5f5f5;
}

h1 {
  margin-bottom: 10px;
  font-size: 42px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.clock {
  font-size: 22px;
}

.day-block {
  background: #111;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid #333;
  border-radius: 10px;
}

.day-header {
  font-size: 22px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  color: #ffd166;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  font-size: 20px;
}

th, td {
  border-bottom: 1px solid #333;
  padding: 8px 6px;
}

th {
  background: #1f1f1f;
}

.tag {
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 14px;
  display: inline-block;
}

.house { background: #2d6a4f; }
.tour { background: #6a2d3c; }
.rental { background: #6a5acd; }

.no-events {
  opacity: .5;
  padding: 10px 0;
}
</style>
</head>

<body>

<h1>ğŸ­ Theatre GESHER</h1>
<h2> Schedule</h2>

<div class="header">
  <div>Live from Google Sheets</div>
  <div class="clock" id="clockTA">Tel Aviv time: --:--:--</div>
</div>

<div id="week">Loading...</div>

<script>

const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8VHJ7usLuV213YvhCULcjqMrH6M22QQ_cLDtP8f6u0cb7XXKbeBVzEoKRGmigGFm_EQvtN17sQGi2/pub?gid=350387760&single=true&output=csv";

// ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº
const COLUMN_MAP = {
  date: ["date", "×ª××¨×™×š"],
  time: ["time", "×©×¢×”"],
  title: ["title", "×©×", "×”×¦×’×”"],
  area: ["area", "type", "×¡×•×’"],
  hall: ["hall", "city", "××•×œ×", "×¢×™×¨"],
  note: ["note", "×”×¢×¨×”"]
};

// CSV parser
function parseCSV(text) {
  const rows = [];
  let row = [], value = "", inside = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i+1];

    if (c === '"' && inside && next === '"') {
      value += '"'; i++;
      continue;
    }

    if (c === '"') {
      inside = !inside;
      continue;
    }

    if (c === ',' && !inside) {
      row.push(value);
      value = "";
      continue;
    }

    if ((c === '\n' || c === '\r') && !inside) {
      if (value || row.length) {
        row.push(value);
        rows.push(row);
        row = [];
        value = "";
      }
      continue;
    }

    value += c;
  }

  if (value || row.length) {
    row.push(value);
    rows.push(row);
  }

  return rows;
}

// Ğ Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ
function detectColumns(header) {
  const map = {};
  for (const key in COLUMN_MAP) {
    const names = COLUMN_MAP[key];
    const idx = header.findIndex(h =>
      names.includes(h.trim().toLowerCase())
    );
    map[key] = idx;
  }
  return map;
}

// Ğ’Ñ€ĞµĞ¼Ñ Ğ¢ĞµĞ»ÑŒ-ĞĞ²Ğ¸Ğ²Ğ°
function updateClock() {
  const el = document.getElementById("clockTA");
  const now = new Date();
  const ta = new Date(now.toLocaleString("en-US",{ timeZone:"Asia/Jerusalem" }));

  el.textContent =
    "Tel Aviv time: " +
    ta.getHours().toString().padStart(2,"0") + ":" +
    ta.getMinutes().toString().padStart(2,"0") + ":" +
    ta.getSeconds().toString().padStart(2,"0");
}

// ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ½ĞµĞ´ĞµĞ»Ğ¸
function renderWeek(events) {
  const container = document.getElementById("week");
  container.innerHTML = "";

  const now = new Date();
  const ta = new Date(now.toLocaleString("en-US",{ timeZone:"Asia/Jerusalem" }));

  const day = ta.getDay();
  const start = new Date(ta);
  start.setDate(ta.getDate() - day);

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    days.push(d);
  }

  const weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

  for (const d of days) {
    const iso = d.toISOString().split("T")[0];

    const block = document.createElement("div");
    block.className = "day-block";

    const header = document.createElement("div");
    header.className = "day-header";
    header.textContent = `${weekdays[d.getDay()]} â€” ${iso}`;

    block.appendChild(header);

    const dayEvents = events
      .filter(e => e.date === iso)
      .sort((a,b)=>(a.time || "").localeCompare(b.time||""));

    if (!dayEvents.length) {
      const empty = document.createElement("div");
      empty.className = "no-events";
      empty.textContent = "No events";
      block.appendChild(empty);
      container.appendChild(block);
      continue;
    }

    const table = document.createElement("table");
    table.innerHTML = `
      <tr>
        <th>Time</th>
        <th>Title</th>
        <th>Hall / City</th>
        <th>Type</th>
        <th>Note</th>
      </tr>
    `;

    for (const ev of dayEvents) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${ev.time || ""}</td>
        <td>${ev.title || ""}</td>
        <td>${ev.hall || ""}</td>
        <td>
          <span class="tag ${
            ["×‘×™×ª","house"].includes((ev.area||"").toLowerCase()) ? "house" :
            ["×—×•×¥","tour"].includes((ev.area||"").toLowerCase()) ? "tour" :
            ["×”×©×›×¨×”","rental"].includes((ev.area||"").toLowerCase()) ? "rental" : ""
          }">${ev.area || ""}</span>
        </td>
        <td>${ev.note || ""}</td>
      `;

      table.appendChild(tr);
    }

    block.appendChild(table);
    container.appendChild(block);
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
async function loadData() {
  try {
    const resp = await fetch(CSV_URL);
    const text = await resp.text();

    const rows = parseCSV(text);
    const header = rows[0].map(h => h.trim().toLowerCase());
    const cols = detectColumns(header);

    const events = rows.slice(1).map(r => ({
      date: r[cols.date],
      time: r[cols.time],
      title: r[cols.title],
      area: r[cols.area],
      hall: r[cols.hall],
      note: r[cols.note]
    })).filter(e => e.date && e.title);

    renderWeek(events);

  } catch (err) {
    document.getElementById("week").innerHTML =
      "<div style='color:red;font-size:22px;'>ERROR LOADING DATA:<br>" + err + "</div>";
  }
}

// INIT
updateClock();
setInterval(updateClock, 1000);
loadData();
setInterval(loadData, 30000); // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞº

</script>
</body>
</html>
