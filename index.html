<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>תיאטרון גשר — לוח הצגות</title>

<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff;
  --card:#f5f5f5;
  --accent:#2563eb;
  --text:#000;
  --muted:#666;

  --col-plan:#34c759;
  --col-ext:#ff9500;
  --col-reh:#ffcc00;
  --col-actor:#af52de;
}

/* темы */
body.theme-light{
  --bg:#ffffff;
  --card:#f3f4f6;   /* чуть темнее кубики, фон белый */
  --text:#000;
}
body.theme-dark{
  --bg:#020617;
  --card:rgba(15,23,42,0.75);
  --text:#f9fafb;
}

/* базовое */
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
}
body{
  display:flex;
  flex-direction:column;
  padding:12px;
  font-family: Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
}

/* шапка */
.top-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-bottom:4px;
}
#theatreName{
  font-weight:700;
  font-size:20px;
}
#yearLabel{
  font-family:'Playfair Display',serif;
  font-size:38px;
  text-align:center;
  flex:1;
}
#clock{
  min-width:130px;
  padding:6px 12px;
  border-radius:16px;
  background:rgba(240,240,240,0.85);
  border:1px solid rgba(180,180,180,0.7);
  text-align:center;
  font-weight:600;
  font-size:16px;
}
body.theme-dark #clock{
  color:#000;
  background:rgba(248,250,252,0.9);
  border-color:rgba(148,163,184,0.9);
}

/* кнопки */
.btn-small{
  padding:6px 12px;
  border-radius:14px;
  border:1px solid #bbb;
  background:rgba(250,250,250,0.9);
  cursor:pointer;
  font-size:14px;
}
.btn-small:hover{
  background:#e6e6e6;
}
.month-controls .btn-small{
  font-size:13px;
  padding:4px 8px;
  border-radius:12px;
}

/* полоса месяца */
.month-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin:6px 0 10px;
}
.month-controls{
  display:flex;
  align-items:center;
  gap:6px;
}
#monthLabel{
  padding:6px 18px;
  border-radius:16px;
  background:#e0e0e0;
  border:2px solid #999;
  font-size:18px;
  font-weight:700;
}
body.theme-dark #monthLabel{
  background:rgba(15,23,42,0.95);
  color:#f9fafb;
  border-color:rgba(148,163,184,0.9);
}
#techPageBtn{
  font-size:16px;
}

/* календарь */
#calendar{
  flex:1;
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.day{
  background:var(--card);
  border-radius:18px;
  padding:10px;
  min-height:160px;
  position:relative;
  overflow:hidden;
  cursor:pointer;
  transition:transform 0.12s, filter 0.3s, opacity 0.3s;
  box-shadow:0 1px 3px rgba(15,23,42,0.08);
}
.day:hover{
  transform:translateY(-2px);
}
.day.past{
  opacity:0.55;
  filter:blur(1px);
}
.day.fog1{
  filter:blur(2px) grayscale(0.3);
  opacity:0.5;
  cursor:default;
}
.day.fog2{
  filter:blur(4px) grayscale(0.6);
  opacity:0.3;
  cursor:default;
}

/* буква дня + число */
.week-letter{
  position:absolute;
  top:4px;
  left:8px;
  font-weight:700;
  opacity:.9;
  font-size:12px;
}
.sabbath{ color:#d33; }
.date-number{
  margin-top:10px;
  font-size:20px;
  font-weight:700;
}
.day-separator{
  margin-top:4px;
  height:1px;
  background:linear-gradient(
    to left,
    transparent 0%,
    #d6d6d6 20%,
    #d6d6d6 80%,
    transparent 100%
  );
}

/* события */
.event{
  margin-top:4px;
  font-size:13px;
  line-height:1.2;
}
.ev-tag{
  display:inline-block;
  font-size:11px;
  padding:2px 8px;
  border-radius:10px;
  margin:2px 4px;
  color:#111;           /* днём текст в плашках чёрный */
  border:1px solid transparent;
}
body.theme-dark .ev-tag{
  color:#fff;
}
.ev-tag-plan{
  background:rgba(52,199,89,0.35);
  border-color:rgba(52,199,89,0.55);
}
.ev-tag-ext{
  background:rgba(255,149,0,0.35);
  border-color:rgba(255,149,0,0.55);
}
.ev-tag-reh{
  background:rgba(255,204,0,0.35);
  border-color:rgba(255,204,0,0.55);
}
.ev-tag-actor{
  background:rgba(175,82,222,0.35);
  border-color:rgba(175,82,222,0.55);
}

.cat-plan{
  background:rgba(52,199,89,0.07);
  border:1px solid rgba(52,199,89,0.22);
}
.cat-ext{
  background:rgba(255,149,0,0.07);
  border:1px solid rgba(255,149,0,0.22);
}
.cat-reh{
  background:rgba(255,204,0,0.07);
  border:1px solid rgba(255,204,0,0.22);
}
.cat-actor{
  background:rgba(175,82,222,0.07);
  border:1px solid rgba(175,82,222,0.22);
}

.event-card{
  border-radius:14px;
  padding:6px 8px;
  margin-top:4px;
}
.event-show{
  display:flex;
  align-items:flex-start;
  gap:6px;
}
.ev-title-block{
  flex:1;
}
.ev-title-block b{
  display:block;
  font-size:13px;
}
.ev-place{
  font-size:11px;
  color:var(--muted);
}
.ev-times-side{
  display:flex;
  flex-direction:column;
  gap:2px;
  direction:ltr;
  font-size:12px;
  font-weight:700;
  color:#007aff;
}
.ev-times-side span{
  white-space:nowrap;
}
.ev-times-line{
  display:none;
}

/* модалка */
#modal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(15,23,42,.18);  /* днём не сильно затемняем */
  align-items:center;
  justify-content:center;
  z-index:50;
}
body.theme-dark #modal{
  background:rgba(0,0,0,.55);
}

#modalContent{
  background:#ffffff;   /* более белое окно днём */
  color:#000;
  border-radius:18px;
  padding:18px;
  max-width:820px;
  width:92%;
  max-height:90vh;
  overflow:auto;
  position:relative;
  border:1px solid rgba(148,163,184,0.35);
  transition: opacity .2s ease, transform .2s ease;
}
body.theme-dark #modalContent{
  color:#ffffff;
}
body.theme-dark .modal-show-block,
body.theme-dark #modalRehearsals,
body.theme-dark #modalLimits,
body.theme-dark #actorsContent,
body.theme-dark #techContent{
  color:#ffffff;
}
@supports (backdrop-filter: blur(8px)){
  body.theme-light #modalContent{
    background:rgba(255,255,255,0.96);
    backdrop-filter:blur(10px);
  }
  body.theme-dark #modalContent{
    background:rgba(15,23,42,0.5);
    backdrop-filter:blur(14px) saturate(1.4);
    border:1px solid rgba(255,255,255,0.4);
  }
}
#closeModal{
  position:absolute;
  left:12px;
  top:8px;
  font-size:22px;
  cursor:pointer;
}

#modalDate,
#actorsDate,
#techDate{
  margin-top:6px;
  margin-bottom:8px;
  text-align:center;
  font-family:'Playfair Display',serif;
  font-size:22px;
}
#modalDayNote{
  margin-bottom:10px;
  font-weight:600;
  text-align:center;
}

.modal-show-block{
  margin-bottom:12px;
  border-radius:14px;
  padding:8px 10px;
}
.modal-show-block h3{
  margin:4px 0;
}

/* НОВОЕ: заголовок + время в одной строке */
.modal-show-title-line{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:baseline;
}
.modal-show-times-inline{
  font-size:0.9em;
  color:#007aff;
  direction:ltr;
}

.modal-show-times{
  margin-top:2px;
  direction:ltr;
  font-weight:700;
  color:#007aff;
}

#modalRehearsals{
  margin-top:10px;
  font-size:13px;
}
.rehearsal-row{
  margin-top:6px;
  margin-bottom:6px;
  border-radius:12px;
  padding:6px 8px;
}
.rehearsal-cols{
  display:flex;
  gap:10px;
}
.rehearsal-col{
  flex:1;
}
.rh-label{
  font-weight:bold;
  margin-bottom:2px;
}
.rh-line{
  white-space:nowrap;
}
.rh-empty{
  color:#aaa;
}

#modalLimits{
  margin-top:8px;
  font-size:13px;
}

#dayViewButtons{
  margin-top:14px;
  display:flex;
  gap:8px;
}

.view-nav{
  margin-bottom:10px;
  display:flex;
  gap:8px;
  justify-content:center;
}
.view-nav .btn-small{
  font-size:13px;
}
#actorsContent,
#techContent{
  font-size:13px;
}

/* подсказка свайпа */
#swipeHint{
  position:fixed;
  top:50%;
  transform:translateY(-50%) scale(0.8);
  width:110px;
  height:40px;
  border-radius:999px;
  background:rgba(15,23,42,0.7);
  color:#f9fafb;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:14px;
  pointer-events:none;
  z-index:60;
  backdrop-filter:blur(10px);
  opacity:0;
  transition:opacity 0.1s, transform 0.1s;
}
body.theme-light #swipeHint{
  background:rgba(255,255,255,0.85);
  color:#111827;
}

/* mobile */
@media(max-width:900px){
  body{
    padding:10px;
  }
  #calendar{
    gap:4px;
  }
  .day{
    min-height:80px;
    padding:6px;
  }
  .week-letter{
    font-size:11px;
    top:3px;
    left:6px;
  }
  .date-number{
    margin-top:6px;
    font-size:15px;
  }
  .event{
    font-size:9px;
    margin-top:2px;
  }
  .event-card{
    border:none;
    background:transparent;
    padding:0;
    margin-top:2px;
    box-shadow:none;
  }
  .ev-title-block{
    display:none;
  }
  .ev-times-side,
  .ev-times-line{
    display:none;
  }
  #yearLabel{
    font-size:26px;
  }
  #monthLabel{
    font-size:14px;
    padding:4px 8px;
  }
  #clock{
    font-size:13px;
    padding:4px 6px;
  }
  #techPageBtn{
    font-size:14px;
    padding:6px 10px;
  }
}
</style>
</head>
<body>

<div class="top-bar">
  <div id="theatreName">תיאטרון גשר</div>
  <div id="yearLabel"></div>
  <div id="clock">--:--:--</div>
</div>

<div class="month-bar">
  <div class="month-controls">
    <button id="prevBtn" class="btn-small" style="visibility:hidden">חודש קודם</button>
    <div id="monthLabel">—</div>
    <button id="nextBtn" class="btn-small">חודש הבא</button>
  </div>
  <button id="techPageBtn" class="btn-small">טכנאים</button>
</div>

<div id="calendar"></div>

<div id="swipeHint"></div>

<div id="modal">
  <div id="modalContent">
    <div id="closeModal">✕</div>

    <div id="dayView">
      <h2 id="modalDate"></h2>
      <div id="modalDayNote"></div>
      <div id="modalEvents"></div>
      <div id="modalRehearsals"></div>
      <div id="modalLimits"></div>
      <div id="dayViewButtons">
        <button id="openActorsBtn" class="btn-small">שחקנים</button>
        <button id="openTechBtn"   class="btn-small">טכנאים</button>
      </div>
    </div>

    <div id="actorsView" style="display:none;">
      <h2 id="actorsDate"></h2>
      <div class="view-nav">
        <button id="actorsHomeBtn" class="btn-small">בית</button>
        <button id="actorsBackBtn" class="btn-small">חזרה</button>
      </div>
      <div id="actorsContent"></div>
    </div>

    <div id="techView" style="display:none;">
      <h2 id="techDate"></h2>
      <div class="view-nav">
        <button id="techHomeBtn" class="btn-small">בית</button>
        <button id="techBackBtn" class="btn-small">חזרה</button>
      </div>
      <div id="techContent"></div>
    </div>

  </div>
</div>

<script>
const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKX0SzQrQDDG-txSI9I2y7F4-MwWXvjIWh0AlG0qmGOpzQ5hyVXNi1wxdkb3PBRpXHvTvbNN6DWvR3/pub?gid=0&single=true&output=csv";

let cachedEvents = [];
const localNow = new Date();
const todayTA = new Date(localNow.toLocaleString('en-US',{timeZone:'Asia/Jerusalem'}));
todayTA.setHours(0,0,0,0);

let viewYear = todayTA.getFullYear();
let viewMonth = todayTA.getMonth();
const maxForward = new Date(todayTA.getFullYear(), todayTA.getMonth()+2, 1);

const nextBtn     = document.getElementById('nextBtn');
const prevBtn     = document.getElementById('prevBtn');
const modal       = document.getElementById('modal');
const closeModal  = document.getElementById('closeModal');
const techPageBtn = document.getElementById('techPageBtn');
const calendarEl  = document.getElementById('calendar');
const swipeHint   = document.getElementById('swipeHint');

const dayView       = document.getElementById('dayView');
const actorsView    = document.getElementById('actorsView');
const techView      = document.getElementById('techView');
const modalContent  = document.getElementById('modalContent');

const modalDateEl   = document.getElementById('modalDate');
const modalDayNoteEl= document.getElementById('modalDayNote');
const modalEventsEl = document.getElementById('modalEvents');
const modalRehearsalsEl = document.getElementById('modalRehearsals');
const modalLimitsEl = document.getElementById('modalLimits');

const openActorsBtn = document.getElementById('openActorsBtn');
const openTechBtn   = document.getElementById('openTechBtn');

const actorsDateEl  = document.getElementById('actorsDate');
const actorsContent = document.getElementById('actorsContent');
const actorsHomeBtn = document.getElementById('actorsHomeBtn');
const actorsBackBtn = document.getElementById('actorsBackBtn');

const techDateEl    = document.getElementById('techDate');
const techContent   = document.getElementById('techContent');
const techHomeBtn   = document.getElementById('techHomeBtn');
const techBackBtn   = document.getElementById('techBackBtn');

let currentDayDate  = null;
let currentDayEvents= [];
let baseModalHeight = null;

/* часы + тема */
function updateClock(){
  const now = new Date();
  const s = new Intl.DateTimeFormat('he-IL',{
    timeZone:'Asia/Jerusalem',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).format(now);
  document.getElementById('clock').textContent = s;
}
function updateTheme(){
  const now = new Date();
  const ta = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Jerusalem'}));
  const hour = ta.getHours();
  const body = document.body;
  body.classList.remove('theme-light','theme-dark');
  if(hour>=7 && hour<19) body.classList.add('theme-light');
  else body.classList.add('theme-dark');
}
setInterval(updateClock,1000);
updateClock();
updateTheme();
setInterval(updateTheme,60000);

techPageBtn.onclick = ()=>{
  alert("דף טכנאים יתווסף בהמשך.");
};

/* CSV */
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
  const rows=[]; let row=[], cell="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'){
      if(inQ && n==='"'){ cell+='"'; i++; continue; }
      inQ=!inQ; continue;
    }
    if(c===',' && !inQ){
      row.push(cell.trim()); cell=""; continue;
    }
    if((c==='\n'||c==='\r') && !inQ){
      if(cell!==""||row.length){ row.push(cell.trim()); rows.push(row); }
      row=[]; cell=""; continue;
    }
    cell+=c;
  }
  if(cell!==""||row.length){ row.push(cell.trim()); rows.push(row); }
  return rows;
}
function esc(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}
function getWeekLetter(d){
  const arr=['א','ב','ג','ד','ה','ו','ש'];
  return arr[d.getDay()];
}
function buildShowGroups(events){
  const map = {};
  for(const ev of events){
    if(ev.category!=='plan_show' && ev.category!=='external_show') continue;
    const key = ev.category+'|'+(ev.title||'')+'|'+(ev.place||'');
    if(!map[key]){
      map[key]={category:ev.category,title:ev.title||'',place:ev.place||'',times:[],note:ev.note||'',limits:ev.limits||''};
    }
    if(ev.time && !map[key].times.includes(ev.time)){
      map[key].times.push(ev.time);
    }
  }
  let groups = Object.values(map);
  groups.forEach(g=>g.times.sort());
  const domestic = groups.filter(g=>g.category==='plan_show');
  const external = groups.filter(g=>g.category==='external_show');
  return domestic.concat(external);
}

async function loadEvents(){
  const res = await fetch(CSV_URL,{cache:'no-store'});
  const txt = await res.text();
  const rows = parseCSV(txt);
  if(!rows.length) return [];
  const header = rows[0].map(h=>(h||'').trim().toLowerCase());
  const idx = name => header.indexOf(name.toLowerCase());
  const ci = {
    dateISO : idx('dateiso'),
    title   : idx('title'),
    time    : idx('time'),
    place   : idx('place'),
    category: idx('category'),
    note    : idx('note'),
    limits  : idx('limits'),
    day_note: idx('day_note'),
    actors  : idx('actors'),
    staff   : idx('staff'),
    source  : idx('source')
  };
  const events=[];
  for(let i=1;i<rows.length;i++){
    const row=rows[i];
    const dateISO=row[ci.dateISO];
    if(!dateISO) continue;
    events.push({
      dateISO,
      title:row[ci.title]||'',
      time:row[ci.time]||'',
      place:row[ci.place]||'',
      category:row[ci.category]||'',
      note:row[ci.note]||'',
      limits:row[ci.limits]||'',
      day_note:row[ci.day_note]||'',
      actors:row[ci.actors]||'',
      staff:row[ci.staff]||'',
      source:row[ci.source]||''
    });
  }
  events.sort((a,b)=>{
    if(a.dateISO<b.dateISO) return -1;
    if(a.dateISO>b.dateISO) return 1;
    const ta=a.time||"99:99", tb=b.time||"99:99";
    if(ta<tb) return -1;
    if(ta>tb) return 1;
    if(a.category<b.category) return -1;
    if(a.category>b.category) return 1;
    return 0;
  });
  return events;
}

/* рендер */
function renderCalendar(){
  const cal = calendarEl;
  cal.innerHTML='';
  document.getElementById('yearLabel').textContent=viewYear;
  document.getElementById('monthLabel').textContent=
    new Intl.DateTimeFormat('he-IL',{month:'long'}).format(new Date(viewYear,viewMonth,1));

  // кнопка назад скрыта на текущем месяце
  if(viewYear===todayTA.getFullYear() && viewMonth===todayTA.getMonth())
    prevBtn.style.visibility='hidden';
  else
    prevBtn.style.visibility='visible';

  const maxY=maxForward.getFullYear(), maxM=maxForward.getMonth();
  if(viewYear===maxY && viewMonth===maxM)
    nextBtn.style.visibility='hidden';
  else
    nextBtn.style.visibility='visible';

  const first=new Date(viewYear,viewMonth,1);
  let start=first.getDay();
  const total=new Date(viewYear,viewMonth+1,0).getDate();

  const isMobile=window.matchMedia('(max-width: 900px)').matches;

  for(let i=0;i<start;i++) cal.appendChild(document.createElement('div'));

  for(let d=1; d<=total; d++){
    const cell=document.createElement('div');
    cell.className='day';

    const iso=`${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    cell.dataset.date=iso;

    const dt=new Date(viewYear,viewMonth,d);
    dt.setHours(0,0,0,0);
    const diffMs=dt-todayTA;
    const diffDays=Math.round(diffMs/(1000*60*60*24));

    if(diffDays<0) cell.classList.add('past');
    if(diffDays>60){
      if(diffDays===61) cell.classList.add('fog1');
      else cell.classList.add('fog2');
    }

    const letter=getWeekLetter(dt);
    const wl=document.createElement('div');
    wl.className='week-letter'+(letter==='ש'?' sabbath':'');
    wl.textContent=letter;
    cell.appendChild(wl);

    const dn=document.createElement('div');
    dn.className='date-number';
    dn.textContent=d;
    cell.appendChild(dn);

    const sep=document.createElement('div');
    sep.className='day-separator';
    cell.appendChild(sep);

    const todays=cachedEvents.filter(ev=>ev.dateISO===iso);
    const showGroups=buildShowGroups(todays);
    const hasRehearsal=todays.some(ev=>ev.category==='morning_rehearsal'||ev.category==='evening_rehearsal');

    if(isMobile){
      const hasPlan=showGroups.some(g=>g.category==='plan_show');
      const hasExt =showGroups.some(g=>g.category==='external_show');

      if(hasPlan){
        const evDiv=document.createElement('div');
        evDiv.className='event';
        evDiv.innerHTML=`<span class="ev-tag ev-tag-plan">הצגה</span>`;
        cell.appendChild(evDiv);
      }
      if(hasExt){
        const evDiv=document.createElement('div');
        evDiv.className='event';
        evDiv.innerHTML=`<span class="ev-tag ev-tag-ext">הצגה חוץ</span>`;
        cell.appendChild(evDiv);
      }
      if(hasRehearsal){
        const rehDiv=document.createElement('div');
        rehDiv.className='event';
        rehDiv.innerHTML=`<span class="ev-tag ev-tag-reh">חזרה</span>`;
        cell.appendChild(rehDiv);
      }
    }else{
      showGroups.forEach(g=>{
        const evDiv=document.createElement('div');
        evDiv.className='event';
        let tagLabel=(g.category==='external_show')?'הצגה חוץ':'הצגה';
        let tagClass=(g.category==='external_show')?'ev-tag-ext':'ev-tag-plan';
        let boxClass=(g.category==='external_show')?'cat-ext':'cat-plan';
        const timesSideHTML=g.times.map(t=>`<span>${esc(t)}</span>`).join('');
        const timesLineText=g.times.join(" , ");
        evDiv.innerHTML=`
          <div class="event-card ${boxClass}">
            <span class="ev-tag ${tagClass}">${esc(tagLabel)}</span>
            <div class="event-show">
              <div class="ev-title-block">
                <b>${esc(g.title)}</b>
                <div class="ev-place">${esc(g.place)}</div>
                <div class="ev-times-line">${esc(timesLineText)}</div>
              </div>
              <div class="ev-times-side">${timesSideHTML}</div>
            </div>
          </div>`;
        cell.appendChild(evDiv);
      });
      if(hasRehearsal){
        const rehDiv=document.createElement('div');
        rehDiv.className='event';
        rehDiv.innerHTML=`
          <div class="event-card cat-reh">
            <span class="ev-tag ev-tag-reh">חזרה</span>
          </div>`;
        cell.appendChild(rehDiv);
      }
    }

    if(dt.getTime()===todayTA.getTime()){
      cell.style.outline='3px solid var(--accent)';
    }

    if(diffDays<=60){
      cell.addEventListener('click',()=>{
        openModal(dt,todays);
      });
    }

    cal.appendChild(cell);
  }
}

/* модалка */
function openModal(dateObj, events){
  currentDayDate=dateObj;
  currentDayEvents=events;
  dayView.style.display='block';
  actorsView.style.display='none';
  techView.style.display='none';

  const dateStr=new Intl.DateTimeFormat('he-IL',{
    weekday:'long',day:'numeric',month:'long',year:'numeric'
  }).format(dateObj);
  modalDateEl.textContent=dateStr;
  actorsDateEl.textContent=dateStr;
  techDateEl.textContent=dateStr;

  const dayNote=(events.find(ev=>ev.day_note)||{}).day_note||"";
  modalDayNoteEl.innerHTML=dayNote?`<span>פתק יום: ${esc(dayNote)}</span>`:"";

  modalEventsEl.innerHTML="";
  const showGroups=buildShowGroups(events);
  if(!showGroups.length){
    modalEventsEl.innerHTML="<p>אין הצגות ביום זה</p>";
  }else{
    showGroups.forEach(g=>{
      const div=document.createElement('div');
      let catLabel=(g.category==='external_show')?'הצגה חוץ':'הצגה';
      let catBoxClass=(g.category==='external_show')?'cat-ext':'cat-plan';
      let catTagClass=(g.category==='external_show')?'ev-tag-ext':'ev-tag-plan';
      const times=g.times.join(" , ");
      div.className=`modal-show-block ${catBoxClass}`;
      div.innerHTML=`
        <span class="ev-tag ${catTagClass}">${esc(catLabel)}</span>
        <h3 class="modal-show-title-line">
          <span>${esc(g.title)}</span>
          <span class="modal-show-times-inline">${esc(times)}</span>
        </h3>
        <p><b>מקום:</b> ${esc(g.place)}</p>
        ${g.note?`<p><b>הערה:</b> ${esc(g.note)}</p>`:""}
      `;
      modalEventsEl.appendChild(div);
    });
  }

  buildRehearsalsView(events);

  const limitsSet=new Set();
  events.forEach(ev=>{
    if(ev.limits){
      String(ev.limits).split(/\r?\n|;/).forEach(x=>{
        const s=x.trim();
        if(s) limitsSet.add(s);
      });
    }
  });
  if(limitsSet.size){
    const lines=Array.from(limitsSet);
    modalLimitsEl.innerHTML=
      `<p><b>אילוצים:</b></p><ul>`+
      lines.map(l=>`<li>${esc(l)}</li>`).join("")+
      `</ul>`;
  }else modalLimitsEl.innerHTML="";

  buildActorsViewContent(events);
  buildTechViewContent(events);

  // плавное всплытие
  modal.style.display='flex';
  modalContent.style.opacity='0';
  modalContent.style.transform='translateY(15px) scale(0.96)';
  requestAnimationFrame(()=>{
    baseModalHeight=modalContent.offsetHeight;
    modalContent.style.minHeight=baseModalHeight+"px";
    modalContent.style.opacity='';
    modalContent.style.transform='';
  });
}

function buildRehearsalsView(events){
  const rehe=events.filter(ev=>ev.category==='morning_rehearsal'||ev.category==='evening_rehearsal');
  if(!rehe.length){
    modalRehearsalsEl.innerHTML="";
    return;
  }
  const groupsMap={};
  for(const ev of rehe){
    const key=ev.title||'חזרה';
    if(!groupsMap[key]) groupsMap[key]={title:ev.title||'',morning:[],evening:[]};
    if(ev.category==='morning_rehearsal') groupsMap[key].morning.push(ev);
    else groupsMap[key].evening.push(ev);
  }
  const groups=Object.values(groupsMap);
  let html="<h3>חזרות</h3>";
  groups.forEach(g=>{
    html+=`<div class="rehearsal-row cat-reh">`;
    if(g.title) html+=`<p><b>${esc(g.title)}</b></p>`;
    html+=`<div class="rehearsal-cols">`;
    html+=`<div class="rehearsal-col"><div class="rh-label">חזרת בוקר</div>`;
    if(g.morning.length){
      g.morning.forEach(ev=>{
        html+=`<div class="rh-line">${esc(ev.time)} — ${esc(ev.place||"")}</div>`;
      });
    }else html+=`<div class="rh-line rh-empty">—</div>`;
    html+=`</div>`;
    html+=`<div class="rehearsal-col"><div class="rh-label">חזרת ערב</div>`;
    if(g.evening.length){
      g.evening.forEach(ev=>{
        html+=`<div class="rh-line">${esc(ev.time)} — ${esc(ev.place||"")}</div>`;
      });
    }else html+=`<div class="rh-line rh-empty">—</div>`;
    html+=`</div></div></div>`;
  });
  modalRehearsalsEl.innerHTML=html;
}

function buildActorsViewContent(events){
  const actorEvents=events.filter(ev=>
    ev.category==='actor_show'||
    ev.category==='morning_rehearsal'||
    ev.category==='evening_rehearsal'
  );
  if(!actorEvents.length){
    actorsContent.innerHTML="<p>אין נתונים לשחקנים ליום זה.</p>";
    return;
  }
  actorsContent.innerHTML="";
  actorEvents.forEach(ev=>{
    let label="";
    switch(ev.category){
      case'actor_show':label='הצגת שחקנים';break;
      case'morning_rehearsal':label='חזרת בוקר';break;
      case'evening_rehearsal':label='חזרת ערב';break;
      default:label=ev.category;
    }
    const block=document.createElement('div');
    block.className='modal-show-block cat-actor';
    block.innerHTML=`
      <p><b>${esc(label)}</b></p>
      <p><b>שעה:</b> ${esc(ev.time)}</p>
      <p><b>מקום:</b> ${esc(ev.place)}</p>
      ${ev.title?`<p><b>שם:</b> ${esc(ev.title)}</p>`:""}
      ${ev.actors?`<p><b>שחקנים:</b> ${esc(ev.actors)}</p>`:""}
      ${ev.note?`<p><b>הערה:</b> ${esc(ev.note)}</p>`:""}
      ${ev.limits?`<p><b>אילוצים:</b> ${esc(ev.limits)}</p>`:""}
    `;
    actorsContent.appendChild(block);
  });
}
function buildTechViewContent(events){
  techContent.innerHTML="<p>מידע לטכנאים יתווסף בהמשך.</p>";
}

/* переключение видов */
openActorsBtn.onclick=()=>{
  if(!currentDayDate) return;
  dayView.style.display='none';
  techView.style.display='none';
  actorsView.style.display='block';
};
openTechBtn.onclick=()=>{
  if(!currentDayDate) return;
  dayView.style.display='none';
  actorsView.style.display='none';
  techView.style.display='block';
};
actorsHomeBtn.onclick=()=>closeModalFunc();
actorsBackBtn.onclick=()=>{
  actorsView.style.display='none';
  techView.style.display='none';
  dayView.style.display='block';
};
techHomeBtn.onclick=()=>closeModalFunc();
techBackBtn.onclick=()=>{
  techView.style.display='none';
  actorsView.style.display='none';
  dayView.style.display='block';
};

function closeModalFunc(){
  modal.style.display='none';
  modalContent.style.minHeight="";
  baseModalHeight=null;
  currentDayDate=null;
  currentDayEvents=[];
}
closeModal.onclick=closeModalFunc;
modal.onclick=e=>{
  if(e.target.id==='modal') closeModalFunc();
};

/* переход месяцев */
function goNextMonth(){
  const maxY=maxForward.getFullYear(), maxM=maxForward.getMonth();
  if(viewYear>maxY || (viewYear===maxY && viewMonth>=maxM)) return;
  viewMonth++;
  if(viewMonth>11){viewMonth=0;viewYear++;}
  renderCalendar();
}
function goPrevMonth(){
  const minY = todayTA.getFullYear();
  const minM = todayTA.getMonth();
  // запрет уходить в месяцы раньше текущего
  if(viewYear<minY || (viewYear===minY && viewMonth<=minM)) return;
  viewMonth--;
  if(viewMonth<0){viewMonth=11;viewYear--;}
  renderCalendar();
}
nextBtn.onclick=goNextMonth;
prevBtn.onclick=goPrevMonth;

/* свайпы и long-press */
let touchStartX=null, touchStartY=null;
let longPressTimer=null;
let swipeActive=false;
let pressCell=null;

function showSwipeHint(dx){
  // свайп влево = חודש קודם, свайп вправо = חודש הבא
  const dir = dx<0 ? 'prev' : 'next';
  const ratio = Math.min(Math.abs(dx)/120,1);
  swipeHint.style.display='flex';
  swipeHint.style.opacity = 0.2+0.6*ratio;
  swipeHint.style.transform = `translateY(-50%) scale(${0.8+0.3*ratio})`;

  if(dir==='next'){
    // вправо – подсказка справа: חודש הבא
    swipeHint.style.right='12px';
    swipeHint.style.left='auto';
    swipeHint.textContent='חודש הבא';
  } else {
    // влево – подсказка слева: חודש קודם
    swipeHint.style.left='12px';
    swipeHint.style.right='auto';
    swipeHint.textContent='חודש קודם';
  }
}
function hideSwipeHint(){
  swipeHint.style.opacity=0;
  swipeHint.style.display='none';
}

function openModalFromCell(cell){
  const iso = cell.dataset.date;
  if(!iso) return;
  const [y,m,d]=iso.split('-').map(Number);
  const dt=new Date(y,m-1,d);
  dt.setHours(0,0,0,0);
  const todays=cachedEvents.filter(ev=>ev.dateISO===iso);
  openModal(dt,todays);
}

function onTouchStart(e){
  if(e.touches.length!==1) return;
  const t=e.touches[0];
  touchStartX=t.clientX;
  touchStartY=t.clientY;
  swipeActive=false;
  pressCell=e.target.closest('.day');
  clearTimeout(longPressTimer);
  longPressTimer=setTimeout(()=>{
    if(!swipeActive && pressCell){
      openModalFromCell(pressCell);
    }
  },800);
}
function onTouchMove(e){
  if(e.touches.length!==1) return;
  const t=e.touches[0];
  const dx=t.clientX-touchStartX;
  const dy=t.clientY-touchStartY;
  if(Math.abs(dx)>30 && Math.abs(dx)>Math.abs(dy)){
    swipeActive=true;
    clearTimeout(longPressTimer);
    showSwipeHint(dx);
    e.preventDefault();
  }
}
function onTouchEnd(e){
  clearTimeout(longPressTimer);
  if(swipeActive){
    const t=e.changedTouches[0];
    const dx=t.clientX-touchStartX;
    hideSwipeHint();
    if(Math.abs(dx)>80){
      // влево = месяц назад (но goPrevMonth сам не даст уйти в прошлое),
      // вправо = месяц вперёд (до +2 месяцев)
      if(dx<0) goPrevMonth();
      else     goNextMonth();
    }
  }
  swipeActive=false;
  pressCell=null;
}

calendarEl.addEventListener('touchstart',onTouchStart,{passive:true});
calendarEl.addEventListener('touchmove',onTouchMove,{passive:false});
calendarEl.addEventListener('touchend',onTouchEnd,{passive:true});
calendarEl.addEventListener('touchcancel',onTouchEnd,{passive:true});

/* старт */
async function start(){
  cachedEvents=await loadEvents();
  renderCalendar();
}
start();
setInterval(start,30000);
window.addEventListener('resize',renderCalendar);
</script>
</body>
</html>