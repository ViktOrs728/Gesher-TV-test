<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>GESHER Calendar</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#ffffff;
  color:#000;
  padding:20px;
}

header{
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:20px;
  gap:20px;
}

#monthLabel{
  font-size:42px;
  font-weight:bold;
  min-width:260px;
  text-align:center;
}

.nav-btn{
  font-size:18px;
  padding:8px 16px;
  border-radius:8px;
  border:1px solid #999;
  background:#f5f5f5;
  cursor:pointer;
}

#clock{
  position:absolute;
  left:20px;
  top:20px;
  font-size:22px;
}

.weekdays{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  text-align:center;
  font-weight:bold;
  padding-bottom:10px;
}

#calendar{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:10px;
}

.day{
  min-height:160px;
  background:#f5f5f5;
  border-radius:20px;
  padding:8px 10px 10px;
  position:relative;
  overflow:hidden;
  cursor:pointer;
}

.day:hover{
  background:#ebebeb;
}

.week-letter{
  position:absolute;
  top:6px;
  left:8px;
  font-size:16px;
  opacity:0.8;
  font-weight:bold;
}

.sabbath{
  color:red;
}

.date-number{
  font-size:28px;
  font-weight:bold;
  margin-top:12px;
}

.event{
  font-size:15px;
  margin-top:8px;
  padding-top:6px;
  border-top:1px solid #ccc;
}

.ev-time{
  font-weight:bold;
}


/* --------- MODAL --------- */

#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
}

#modalContent{
  width:90%;
  max-width:700px;
  max-height:90vh;
  background:#ffffff;
  color:#000;
  border-radius:25px;
  padding:25px;
  overflow-y:auto;
  position:relative;
}

#closeModal{
  position:absolute;
  top:15px;
  left:20px;
  font-size:24px;
  cursor:pointer;
}


/* --------- MOBILE --------- */

@media (max-width: 800px){
  #calendar{ gap:5px; }
  .day{ min-height:90px; }
  .event{ display:none; }
  .date-number{ font-size:20px; }
  #monthLabel{ font-size:26px; }
}
</style>
</head>

<body>

<div id="clock">--:--</div>

<header>
  <button class="nav-btn" id="nextBtn">◀ חודש הבא</button>
  <div id="monthLabel"></div>
  <button class="nav-btn" id="prevBtn" style="visibility:hidden;">חודש קודם ▶</button>
</header>

<div class="weekdays">
  <div>א</div><div>ב</div><div>ג</div>
  <div>ד</div><div>ה</div><div>ו</div><div>ש</div>
</div>

<div id="calendar"></div>


<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
      <div id="closeModal">✕</div>
      <h2 id="modalDate"></h2>
      <div id="modalEvents"></div>
  </div>
</div>


<script>

/* === DATA === */

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8VHJ7usLuV213YvhCULcjqMrH6M22QQ_cLDtP8f6u0cb7XXKbeBVzEoKRGmigGFm_EQvtN17sQGi2/pub?output=csv";

let allEvents = [];
let currentDate = new Date();
const today = new Date();


/* === CLOCK === */

function updateClock(){
  const now = new Date();
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("he-IL",
      {timeZone:"Asia/Jerusalem",hour:"2-digit",minute:"2-digit"}).format(now);
}
setInterval(updateClock,1000);
updateClock();


/* === CSV PARSER === */

function parseCSV(text){
  const rows = [];
  let row = [], cell = "", insideQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];

    if(c === '"'){
      if(insideQuotes && n === '"'){ cell+='"'; i++; }
      else insideQuotes = !insideQuotes;
      continue;
    }

    if(c === ',' && !insideQuotes){
      row.push(cell.trim()); cell=""; continue;
    }

    if((c==='\n'||c==='\r') && !insideQuotes){
      if(cell || row.length){ row.push(cell.trim()); rows.push(row); }
      row=[]; cell="";
      continue;
    }

    cell+=c;
  }

  if(cell || row.length){ row.push(cell.trim()); rows.push(row); }

  return rows;
}


/* === UTIL === */

function split(text){
  if(!text) return [];
  return text.split(/\n|;/).map(t=>t.trim()).filter(Boolean);
}

function getWeekLetter(date){
  const letters = ["א","ב","ג","ד","ה","ו","ש"];
  return letters[date.getDay()];
}


/* === LOAD DATA === */

async function loadData(){
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = parseCSV(text);

  const headers = rows[0];
  const col = (n) => headers.indexOf(n);

  const i = {
    date: col("תאריך"),
    title: col("שם ההצגה"),
    time: col("שעה"),
    place: col("מקום")
  };

  allEvents = [];

  rows.slice(1).forEach(r=>{
    const date = r[i.date];
    if(!date) return;

    const titles = split(r[i.title]);
    const times  = split(r[i.time]);
    const places = split(r[i.place]);

    const max = Math.max(titles.length,times.length,places.length);

    for(let k=0;k<max;k++){
      allEvents.push({
        date,
        title: titles[k]||"",
        time: times[k]||"",
        place: places[k]||""
      });
    }
  });

  buildCalendar();
}


/* === CALENDAR === */

function buildCalendar(){

  const cal = document.getElementById("calendar");
  cal.innerHTML="";

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById("monthLabel").textContent =
    new Intl.DateTimeFormat('he-IL',{month:'long',year:'numeric'}).format(currentDate);

  // кнопка возврата — только если не текущий месяц
  if(month === today.getMonth() && year === today.getFullYear()){
    prevBtn.style.visibility = "hidden";
  } else {
    prevBtn.style.visibility = "visible";
  }

  const first = new Date(year,month,1);
  let start = first.getDay();
  if(start===0) start=7;

  const total = new Date(year,month+1,0).getDate();

  for(let i=1;i<start;i++) cal.appendChild(document.createElement("div"));

  for(let d=1;d<=total;d++){
    const dayDiv = document.createElement("div");
    dayDiv.className="day";

    const full = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const date = new Date(year,month,d);

    const letter = getWeekLetter(date);
    const isShabbat = letter === "ש";

    const weekDiv = document.createElement("div");
    weekDiv.className = "week-letter" + (isShabbat ? " sabbath" : "");
    weekDiv.textContent = letter;

    dayDiv.appendChild(weekDiv);

    dayDiv.innerHTML += `<div class="date-number">${d}</div>`;

    const todays = allEvents.filter(e=>e.date===full);

    todays.forEach(e=>{
      const ev = document.createElement("div");
      ev.className="event";
      ev.innerHTML=`
        <div class="ev-time">${e.time}</div>
        <b>${e.title}</b>
        <div>${e.place}</div>
      `;
      dayDiv.appendChild(ev);
    });

    dayDiv.onclick=()=>openModal(date, todays);

    cal.appendChild(dayDiv);
  }
}


/* === MODAL === */

function openModal(date, events){
  document.getElementById("modalDate").textContent =
   new Intl.DateTimeFormat('he-IL',{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(date);

  const eventsDiv = document.getElementById("modalEvents");
  eventsDiv.innerHTML="";

  if(!events.length){
    eventsDiv.innerHTML="<p>אין אירועים ביום זה</p>";
  }

  events.forEach(e=>{
    const div=document.createElement("div");
    div.innerHTML=`
      <h3>${e.title}</h3>
      <p>שעה: ${e.time}</p>
      <p>מקום: ${e.place}</p>
      <hr>
    `;
    eventsDiv.appendChild(div);
  });

  modal.style.display="flex";
}

closeModal.onclick=()=>modal.style.display="none";
modal.onclick=(e)=>{ if(e.target.id==="modal") modal.style.display="none"; }


/* === BUTTONS === */

nextBtn.onclick = () =>{
  currentDate.setMonth(currentDate.getMonth()+1);
  buildCalendar();
}

prevBtn.onclick = () =>{
  currentDate.setMonth(currentDate.getMonth()-1);
  buildCalendar();
}


/* === START === */

loadData();
setInterval(loadData,30000);

</script>

</body>
</html>