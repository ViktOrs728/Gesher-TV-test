<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>תיאטרון גשר — לוח הצגות</title>

<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff;
  --card:#f5f5f5;
  --accent:#2563eb;
  --text:#000;
  --muted:#666;
}

/* базовое */
*{box-sizing:border-box}
body{
  margin:0;
  padding:18px;
  font-family: Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ─── верхняя строка: театр, год, часы ─── */
.top-bar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:6px;
}
#theatreName{
  font-weight:700;
  font-size:20px;
}
#yearLabel{
  font-family:'Playfair Display',serif;
  font-size:44px;
  text-align:center;
  flex:1;
}
.right-top{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}
#clock{
  min-width:140px;
  padding:8px 12px;
  border-radius:14px;
  background:#f0f0f0;
  border:1px solid #ddd;
  text-align:center;
  font-weight:600;
  font-size:18px;
}

/* общая кнопка */
.btn-small{
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #bbb;
  background:#fafafa;
  cursor:pointer;
  font-size:14px;
}
.btn-small:hover{
  background:#e6e6e6;
}

/* ─── строка месяца + кнопки ─── */
.month-bar{
  display:flex;
  justify-content:space-between;  /* слева – месяцы, справа – טכנאים */
  align-items:center;
  gap:8px;
  margin:12px 0 18px;
  margin-left:16px; /* чуть отодвигаем от левого края */
}
.month-controls{
  display:flex;
  align-items:center;
  gap:8px;
}
#monthLabel{
  padding:6px 14px;
  border-radius:14px;
  background:#e0e0e0;
  border:1px solid #c8c8c8;
  font-size:18px;
  font-weight:700;
}
#techPageBtn{
  font-size:18px;        /* как часы */
  padding:8px 14px;      /* крупнее обычной кнопки */
  border-radius:14px;
}

/* ─── календарь ─── */
#calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}

/* ячейка дня */
.day{
  background:var(--card);
  border-radius:16px;
  padding:10px;
  min-height:140px;
  position:relative;
  overflow:hidden;
  cursor:pointer;
  transition:0.12s;
}
.day:hover{
  transform:translateY(-2px);
}

/* буква дня недели в углу */
.week-letter{
  position:absolute;
  top:6px;
  left:8px;
  font-weight:700;
  opacity:.9;
  font-size:13px;
}
.sabbath{ color:#d33; }

/* число дня — поднято ближе к верху */
.date-number{
  margin-top:16px;
  font-size:22px;
  font-weight:700;
}

/* горизонтальная полоска под датой — ЕСТЬ ВСЕГДА */
.day-separator{
  margin-top:4px;
  border-top:1px solid #d6d6d6;
}

/* блок события в ячейке (только спектакли + плашка חזרה) */
.event{
  margin-top:4px;
  font-size:12px;
  line-height:1.2;
}
.ev-tag{
  display:inline-block;
  font-size:10px;
  padding:2px 4px;
  border-radius:6px;
  background:#ddd;
  margin-bottom:2px;
}
.rehearsal-badge .ev-tag{
  background:#ffe0b2;
}

/* строка спектакля (desktop) */
.event-show{
  display:flex;
  align-items:flex-start;
  gap:4px;
}
.ev-title-block{
  flex:1;
}
.ev-title-block b{
  display:block;
}
.ev-place{
  font-size:11px;
  color:var(--muted);
}

/* варианты времени:
   - .ev-times-side: столбик слева (desktop)
   - .ev-times-line: строка под названием (mobile) */
.ev-times-side{
  display:flex;
  flex-direction:column;
  gap:2px;
  direction:ltr;
  font-size:11px;
  font-weight:700;
  color:#3fb0ff;
}
.ev-times-side span{
  white-space:nowrap;
}
.ev-times-line{
  display:none;
  margin-top:2px;
  direction:ltr;
  font-size:11px;
  font-weight:700;
  color:#3fb0ff;
}

/* ─── модальное окно ─── */
#modal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,.55);
  align-items:center;
  justify-content:center;
  z-index:50;
}
#modalContent{
  background:#fff;
  color:#000;
  border-radius:18px;
  padding:22px;
  max-width:820px;
  width:92%;
  max-height:90vh;
  overflow:auto;
  position:relative;
}
#closeModal{
  position:absolute;
  left:16px;
  top:12px;
  font-size:22px;
  cursor:pointer;
}

/* дневной вид модалки */
#dayView h2,
#actorsView h2,
#techView h2{
  margin-top:0;
}
#modalDayNote{
  margin-bottom:10px;
  font-weight:600;
}
.modal-show-block{
  margin-bottom:12px;
}
.modal-show-block h3{
  margin:4px 0;
}
.modal-show-type{
  font-weight:bold;
}
.modal-show-times{
  margin-top:2px;
  direction:ltr;
  font-weight:700;
  color:#3fb0ff;
}
#modalRehearsals{
  margin-top:8px;
  font-size:13px;
}
.rehearsal-row{
  margin-top:6px;
  margin-bottom:6px;
  border-top:1px solid #eee;
  padding-top:6px;
}
.rehearsal-cols{
  display:flex;
  gap:10px;
}
.rehearsal-col{
  flex:1;
}
.rh-label{
  font-weight:bold;
  margin-bottom:2px;
}
.rh-line{
  white-space:nowrap;
}
.rh-empty{
  color:#aaa;
}

#modalLimits{
  margin-top:10px;
  font-size:13px;
}
#dayViewButtons{
  margin-top:14px;
  display:flex;
  gap:8px;
}

/* актёрский и тех-вид */
.view-nav{
  margin-bottom:10px;
  display:flex;
  gap:8px;
}
.view-nav .btn-small{
  font-size:13px;
}
#actorsContent,
#techContent{
  font-size:13px;
}

/* ─── адаптация для телефона, НО 7 колонок сохраняем ─── */
@media(max-width:900px){
  #calendar{
    grid-template-columns:repeat(7,1fr);
    gap:4px;
  }
  .day{
    min-height:90px;
    padding:6px;
  }
  .week-letter{
    font-size:11px;
    top:4px;
    left:4px;
  }
  .date-number{
    margin-top:14px;
    font-size:16px;
  }
  .event{
    font-size:9px;
    margin-top:3px;
  }

  /* мобильная логика:
     - плашка הצגה
     - под ней название
     - под названием время (строкой)
     - место не показываем внутри ячейки */
  .ev-place{
    display:none;
  }
  .ev-times-side{
    display:none;
  }
  .ev-times-line{
    display:block;
  }

  #yearLabel{
    font-size:28px;
  }
  #monthLabel{
    font-size:16px;
    padding:4px 10px;
  }
  #clock{
    font-size:14px;
    padding:6px 8px;
  }
  #techPageBtn{
    font-size:14px;
    padding:6px 10px;
  }
}
</style>
</head>
<body>

<div class="top-bar">
  <div id="theatreName">תיאטרון גשר</div>
  <div id="yearLabel"></div>
  <div class="right-top">
    <div id="clock">--:--:--</div>
  </div>
</div>

<!-- СЛЕВА: [кнопки месяцев]  СПРАВА: [טכנאים] -->
<div class="month-bar">
  <div class="month-controls">
    <button id="prevBtn" class="btn-small" style="visibility:hidden">חודש קודם</button>
    <div id="monthLabel">—</div>
    <button id="nextBtn" class="btn-small">חודש הבא</button>
  </div>
  <button id="techPageBtn" class="btn-small">טכנאים</button>
</div>

<div id="calendar"></div>

<!-- модалка -->
<div id="modal">
  <div id="modalContent">
    <div id="closeModal">✕</div>

    <!-- основной (дневной) вид -->
    <div id="dayView">
      <h2 id="modalDate"></h2>
      <div id="modalDayNote"></div>
      <div id="modalEvents"></div>
      <div id="modalRehearsals"></div>
      <div id="modalLimits"></div>
      <div id="dayViewButtons">
        <button id="openActorsBtn" class="btn-small">שחקנים</button>
        <button id="openTechBtn"   class="btn-small">טכנאים</button>
      </div>
    </div>

    <!-- актёрский вид -->
    <div id="actorsView" style="display:none;">
      <h2 id="actorsDate"></h2>
      <div class="view-nav">
        <button id="actorsHomeBtn" class="btn-small">בית</button>
        <button id="actorsBackBtn" class="btn-small">חזרה</button>
      </div>
      <div id="actorsContent"></div>
    </div>

    <!-- тех-вид -->
    <div id="techView" style="display:none;">
      <h2 id="techDate"></h2>
      <div class="view-nav">
        <button id="techHomeBtn" class="btn-small">בית</button>
        <button id="techBackBtn" class="btn-small">חזרה</button>
      </div>
      <div id="techContent"></div>
    </div>

  </div>
</div>

<script>
/* === URL MasterFeed === */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKX0SzQrQDDG-txSI9I2y7F4-MwWXvjIWh0AlG0qmGOpzQ5hyVXNi1wxdkb3PBRpXHvTvbNN6DWvR3/pub?gid=0&single=true&output=csv";

let cachedEvents = [];
const today = new Date();
let viewYear = today.getFullYear();
let viewMonth = today.getMonth();

// максимум на 2 месяца вперёд
const maxForward = new Date(today.getFullYear(), today.getMonth() + 2, 1);

const nextBtn     = document.getElementById('nextBtn');
const prevBtn     = document.getElementById('prevBtn');
const modal       = document.getElementById('modal');
const closeModal  = document.getElementById('closeModal');
const techPageBtn = document.getElementById('techPageBtn');

const dayView       = document.getElementById('dayView');
const actorsView    = document.getElementById('actorsView');
const techView      = document.getElementById('techView');
const modalContent  = document.getElementById('modalContent');

const modalDateEl   = document.getElementById('modalDate');
const modalDayNoteEl= document.getElementById('modalDayNote');
const modalEventsEl = document.getElementById('modalEvents');
const modalRehearsalsEl = document.getElementById('modalRehearsals');
const modalLimitsEl = document.getElementById('modalLimits');

const openActorsBtn = document.getElementById('openActorsBtn');
const openTechBtn   = document.getElementById('openTechBtn');

const actorsDateEl  = document.getElementById('actorsDate');
const actorsContent = document.getElementById('actorsContent');
const actorsHomeBtn = document.getElementById('actorsHomeBtn');
const actorsBackBtn = document.getElementById('actorsBackBtn');

const techDateEl    = document.getElementById('techDate');
const techContent   = document.getElementById('techContent');
const techHomeBtn   = document.getElementById('techHomeBtn');
const techBackBtn   = document.getElementById('techBackBtn');

let currentDayDate  = null;
let currentDayEvents= [];
let baseModalHeight = null;

/* === часы === */
function updateClock(){
  const now = new Date();
  const s = new Intl.DateTimeFormat('he-IL',{
    timeZone:'Asia/Jerusalem',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).format(now);
  document.getElementById('clock').textContent = s;
}
setInterval(updateClock,1000);
updateClock();

/* кнопка "טכנאים" в шапке месяцев — пока заглушка */
techPageBtn.onclick = () => {
  alert("דף טכנאים יתווסף בהמשך.");
};

/* === парсер csv === */
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
  const rows=[]; let row=[], cell="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'){
      if(inQ && n==='"'){ cell+='"'; i++; continue; }
      inQ = !inQ; continue;
    }
    if(c===',' && !inQ){
      row.push(cell.trim()); cell=""; continue;
    }
    if((c==='\n'||c==='\r') && !inQ){
      if(cell!==""||row.length){ row.push(cell.trim()); rows.push(row); }
      row=[]; cell=""; continue;
    }
    cell+=c;
  }
  if(cell!==""||row.length){ row.push(cell.trim()); rows.push(row); }
  return rows;
}

/* помощники */
function esc(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}
function getWeekLetter(d){
  const arr=['א','ב','ג','ד','ה','ו','ש']; // 0=Sunday=א ... 6=Saturday=ש
  return arr[d.getDay()];
}

/* группировка спектаклей по (category, title, place) + времена */
function buildShowGroups(events){
  const map = {};
  for(const ev of events){
    if(ev.category!=='plan_show' && ev.category!=='external_show') continue;
    const key = ev.category + '|' + (ev.title||'') + '|' + (ev.place||'');
    if(!map[key]){
      map[key] = {
        category: ev.category,
        title: ev.title || '',
        place: ev.place || '',
        times: [],
        note: ev.note || '',
        limits: ev.limits || ''
      };
    }
    if(ev.time && !map[key].times.includes(ev.time)){
      map[key].times.push(ev.time);
    }
  }
  let groups = Object.values(map);
  groups.forEach(g => g.times.sort());
  const domestic = groups.filter(g=>g.category==='plan_show');
  const external = groups.filter(g=>g.category==='external_show');
  return domestic.concat(external);
}

/* === загрузка событий из MasterFeed === */
async function loadEvents(){
  const res = await fetch(CSV_URL,{cache:'no-store'});
  const txt = await res.text();
  const rows = parseCSV(txt);
  if(!rows.length) return [];

  const header = rows[0].map(h => (h||'').trim().toLowerCase());
  const idx = (name) => header.indexOf(name.toLowerCase());

  const ci = {
    dateISO : idx('dateiso'),
    title   : idx('title'),
    time    : idx('time'),
    place   : idx('place'),
    category: idx('category'),
    note    : idx('note'),
    limits  : idx('limits'),
    day_note: idx('day_note'),
    actors  : idx('actors'),
    staff   : idx('staff'),
    source  : idx('source')
  };

  const events = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    const dateISO = row[ci.dateISO];
    if(!dateISO) continue;
    events.push({
      dateISO: dateISO,
      title: row[ci.title]   || '',
      time:  row[ci.time]    || '',
      place: row[ci.place]   || '',
      category: row[ci.category] || '',
      note:  row[ci.note]    || '',
      limits:row[ci.limits]  || '',
      day_note: row[ci.day_note] || '',
      actors: row[ci.actors] || '',
      staff:  row[ci.staff]  || '',
      source: row[ci.source] || ''
    });
  }

  events.sort((a,b)=>{
    if(a.dateISO < b.dateISO) return -1;
    if(a.dateISO > b.dateISO) return 1;
    const ta = a.time || "99:99";
    const tb = b.time || "99:99";
    if(ta < tb) return -1;
    if(ta > tb) return 1;
    if(a.category < b.category) return -1;
    if(a.category > b.category) return 1;
    return 0;
  });

  return events;
}

/* === рендер календаря === */
function renderCalendar(){
  const cal = document.getElementById('calendar');
  cal.innerHTML='';

  document.getElementById('yearLabel').textContent = viewYear;
  document.getElementById('monthLabel').textContent =
    new Intl.DateTimeFormat('he-IL',{month:'long'}).format(new Date(viewYear,viewMonth,1));

  // prev: только если не текущий месяц
  if(viewYear===today.getFullYear() && viewMonth===today.getMonth())
    prevBtn.style.visibility='hidden';
  else
    prevBtn.style.visibility='visible';

  // next: только пока не дошли до +2 месяцев от сегодня
  const maxY = maxForward.getFullYear();
  const maxM = maxForward.getMonth();
  if(viewYear===maxY && viewMonth===maxM)
    nextBtn.style.visibility='hidden';
  else
    nextBtn.style.visibility='visible';

  const first = new Date(viewYear,viewMonth,1);
  let start = first.getDay();   // 0=Sunday
  const total = new Date(viewYear,viewMonth+1,0).getDate();

  for(let i=0;i<start;i++){
    cal.appendChild(document.createElement('div'));
  }

  for(let d=1; d<=total; d++){
    const cell = document.createElement('div');
    cell.className='day';

    const iso = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dt  = new Date(viewYear,viewMonth,d);

    const letter = getWeekLetter(dt);
    const wl = document.createElement('div');
    wl.className = 'week-letter' + (letter==='ש'?' sabbath':'');
    wl.textContent = letter;
    cell.appendChild(wl);

    const dn = document.createElement('div');
    dn.className='date-number';
    dn.textContent=d;
    cell.appendChild(dn);

    // линия под датой — всегда
    const sep = document.createElement('div');
    sep.className = 'day-separator';
    cell.appendChild(sep);

    const todays = cachedEvents.filter(ev=>ev.dateISO===iso);
    const showGroups = buildShowGroups(todays);

    // спектакли
    showGroups.forEach(g=>{
      const evDiv = document.createElement('div');
      evDiv.className='event';

      let tagLabel = (g.category === 'external_show') ? 'הצגה חוץ' : 'הצגה';

      const timesSideHTML = g.times.map(t=>`<span>${esc(t)}</span>`).join('');
      const timesLineText = g.times.join(" , ");

      evDiv.innerHTML = `
        <div class="ev-tag">${esc(tagLabel)}</div>
        <div class="event-show">
          <div class="ev-title-block">
            <b>${esc(g.title)}</b>
            <div class="ev-place">${esc(g.place)}</div>
            <div class="ev-times-line">${esc(timesLineText)}</div>
          </div>
          <div class="ev-times-side">${timesSideHTML}</div>
        </div>
      `;
      cell.appendChild(evDiv);
    });

    // плашка "חזרה", если есть репетиции
    const hasRehearsal = todays.some(ev =>
      ev.category === 'morning_rehearsal' ||
      ev.category === 'evening_rehearsal'
    );
    if(hasRehearsal){
      const rehDiv = document.createElement('div');
      rehDiv.className = 'event rehearsal-badge';
      rehDiv.innerHTML = `<div class="ev-tag">חזרה</div>`;
      cell.appendChild(rehDiv);
    }

    if(viewYear===today.getFullYear() && viewMonth===today.getMonth() && d===today.getDate()){
      cell.style.outline = '3px solid var(--accent)';
    }

    cell.addEventListener('click', ()=>openModal(dt,todays));
    cal.appendChild(cell);
  }
}

/* === модалка для дня === */
function openModal(dateObj, events){
  currentDayDate   = dateObj;
  currentDayEvents = events;

  // показать дневной вид, спрятать остальные
  dayView.style.display    = 'block';
  actorsView.style.display = 'none';
  techView.style.display   = 'none';

  const dateStr = new Intl.DateTimeFormat('he-IL',{
    weekday:'long',day:'numeric',month:'long',year:'numeric'
  }).format(dateObj);
  modalDateEl.textContent  = dateStr;
  actorsDateEl.textContent = dateStr;
  techDateEl.textContent   = dateStr;

  // общий "פתק יום"
  const dayNote = (events.find(ev=>ev.day_note) || {}).day_note || "";
  modalDayNoteEl.innerHTML = dayNote ? `<span>פתק יום: ${esc(dayNote)}</span>` : "";

  // спектакли
  modalEventsEl.innerHTML = "";
  const showGroups = buildShowGroups(events);

  if(!showGroups.length){
    modalEventsEl.innerHTML = "<p>אין הצגות ביום זה</p>";
  } else {
    showGroups.forEach(g=>{
      const div = document.createElement('div');
      div.className = 'modal-show-block';

      let catLabel = (g.category === 'external_show') ? 'הצגה חוץ' : 'הצגה';
      const times = g.times.join(" , ");

      div.innerHTML = `
        <p class="modal-show-type">${esc(catLabel)}</p>
        <h3>${esc(g.title)}</h3>
        <p class="modal-show-times">${esc(times)}</p>
        <p><b>מקום:</b> ${esc(g.place)}</p>
        ${g.note ? `<p><b>הערה:</b> ${esc(g.note)}</p>` : ""}
        <hr>
      `;
      modalEventsEl.appendChild(div);
    });
  }

  // блок "חזרות" перед אילוצים
  buildRehearsalsView(events);

  // אילוצים — снизу, собранные со всех событий
  const limitsSet = new Set();
  events.forEach(ev=>{
    if(ev.limits){
      String(ev.limits).split(/\r?\n|;/).forEach(x=>{
        const s = x.trim();
        if(s) limitsSet.add(s);
      });
    }
  });
  if(limitsSet.size){
    const lines = Array.from(limitsSet);
    modalLimitsEl.innerHTML =
      `<p><b>אילוצים:</b></p><ul>` +
      lines.map(l=>`<li>${esc(l)}</li>`).join("") +
      `</ul>`;
  } else {
    modalLimitsEl.innerHTML = "";
  }

  // актёрский и тех-контент для отдельного вида
  buildActorsViewContent(events);
  buildTechViewContent(events);

  modal.style.display='flex';

  // фиксируем минимальную высоту, чтобы виды не "прыгали"
  requestAnimationFrame(()=>{
    baseModalHeight = modalContent.offsetHeight;
    modalContent.style.minHeight = baseModalHeight + "px";
  });
}

/* блок хоровод с "חזרות" в дневном виде */
function buildRehearsalsView(events){
  const rehe = events.filter(ev =>
    ev.category === 'morning_rehearsal' ||
    ev.category === 'evening_rehearsal'
  );
  if(!rehe.length){
    modalRehearsalsEl.innerHTML = "";
    return;
  }

  const groupsMap = {};
  for(const ev of rehe){
    const key = ev.title || 'חזרה';
    if(!groupsMap[key]){
      groupsMap[key] = { title: ev.title || '', morning:[], evening:[] };
    }
    if(ev.category === 'morning_rehearsal'){
      groupsMap[key].morning.push(ev);
    } else if(ev.category === 'evening_rehearsal'){
      groupsMap[key].evening.push(ev);
    }
  }
  const groups = Object.values(groupsMap);

  let html = "<h3>חזרות</h3>";
  groups.forEach(g=>{
    html += `<div class="rehearsal-row">`;
    if(g.title){
      html += `<p><b>${esc(g.title)}</b></p>`;
    }
    html += `<div class="rehearsal-cols">`;

    // בוקר
    html += `<div class="rehearsal-col"><div class="rh-label">חזרת בוקר</div>`;
    if(g.morning.length){
      g.morning.forEach(ev=>{
        html += `<div class="rh-line">${esc(ev.time)} — ${esc(ev.place || "")}</div>`;
      });
    } else {
      html += `<div class="rh-line rh-empty">—</div>`;
    }
    html += `</div>`;

    // ערב
    html += `<div class="rehearsal-col"><div class="rh-label">חזרת ערב</div>`;
    if(g.evening.length){
      g.evening.forEach(ev=>{
        html += `<div class="rh-line">${esc(ev.time)} — ${esc(ev.place || "")}</div>`;
      });
    } else {
      html += `<div class="rh-line rh-empty">—</div>`;
    }
    html += `</div>`;

    html += `</div></div>`;
  });

  modalRehearsalsEl.innerHTML = html;
}

/* актёрский контент в отдельном окне */
function buildActorsViewContent(events){
  const actorEvents = events.filter(ev =>
    ev.category === 'actor_show' ||
    ev.category === 'morning_rehearsal' ||
    ev.category === 'evening_rehearsal'
  );

  if(!actorEvents.length){
    actorsContent.innerHTML = "<p>אין נתונים לשחקנים ליום זה.</p>";
    return;
  }

  actorsContent.innerHTML = "";
  actorEvents.forEach(ev=>{
    let label="";
    switch(ev.category){
      case 'actor_show':         label='הצגת שחקנים'; break;
      case 'morning_rehearsal':  label='חזרת בוקר';   break;
      case 'evening_rehearsal':  label='חזרת ערב';    break;
      default:                   label=ev.category;
    }
    const block = document.createElement('div');
    block.style.marginBottom = '10px';
    block.innerHTML = `
      <p><b>${esc(label)}</b></p>
      <p><b>שעה:</b> ${esc(ev.time)}</p>
      <p><b>מקום:</b> ${esc(ev.place)}</p>
      ${ev.title  ? `<p><b>שם:</b> ${esc(ev.title)}</p>`   : ""}
      ${ev.actors ? `<p><b>שחקנים:</b> ${esc(ev.actors)}</p>` : ""}
      ${ev.note   ? `<p><b>הערה:</b> ${esc(ev.note)}</p>` : ""}
      ${ev.limits ? `<p><b>אילוצים:</b> ${esc(ev.limits)}</p>` : ""}
      <hr>
    `;
    actorsContent.appendChild(block);
  });
}

/* тех-контент — пока заглушка */
function buildTechViewContent(events){
  techContent.innerHTML = "<p>מידע לטכנאים יתווסף בהמשך.</p>";
}

/* переключение видов в модалке */
openActorsBtn.onclick = ()=>{
  if(!currentDayDate) return;
  dayView.style.display    = 'none';
  techView.style.display   = 'none';
  actorsView.style.display = 'block';
};

openTechBtn.onclick = ()=>{
  if(!currentDayDate) return;
  dayView.style.display    = 'none';
  actorsView.style.display = 'none';
  techView.style.display   = 'block';
};

actorsHomeBtn.onclick = ()=>{
  closeModalFunc();
};
actorsBackBtn.onclick = ()=>{
  actorsView.style.display = 'none';
  techView.style.display   = 'none';
  dayView.style.display    = 'block';
};

techHomeBtn.onclick = ()=>{
  closeModalFunc();
};
techBackBtn.onclick = ()=>{
  techView.style.display   = 'none';
  actorsView.style.display = 'none';
  dayView.style.display    = 'block';
};

/* закрытие модалки */
function closeModalFunc(){
  modal.style.display='none';
  modalContent.style.minHeight = "";
  baseModalHeight = null;
  currentDayDate = null;
  currentDayEvents = [];
}
closeModal.onclick = closeModalFunc;
modal.onclick = e=>{
  if(e.target.id==='modal') closeModalFunc();
};

/* === кнопки месяцев === */
nextBtn.onclick = ()=>{
  const maxY = maxForward.getFullYear();
  const maxM = maxForward.getMonth();
  if(viewYear>maxY || (viewYear===maxY && viewMonth>=maxM)) return;

  viewMonth++;
  if(viewMonth>11){ viewMonth=0; viewYear++; }
  renderCalendar();
};
prevBtn.onclick = ()=>{
  viewMonth--;
  if(viewMonth<0){ viewMonth=11; viewYear--; }
  renderCalendar();
};

/* === старт === */
async function start(){
  cachedEvents = await loadEvents();
  renderCalendar();
}
start();
setInterval(start,30000);
</script>
</body>
</html>
