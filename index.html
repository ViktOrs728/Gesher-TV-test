<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>GESHER Calendar</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#ffffff;
  color:#000;
  padding:20px;
}

header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:20px;
}

#logo{
  height:80px;
}

#monthLabel{
  font-size:42px;
  text-align:center;
  flex:1;
}

#clock{
  font-size:28px;
}

.weekdays{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  text-align:center;
  font-weight:bold;
  padding-bottom:10px;
}

.weekdays div{
  padding:10px 0;
}

#calendar{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:10px;
}

.day{
  min-height:160px;
  background:#f5f5f5;
  border-radius:20px;
  padding:8px 10px 10px;
  position:relative;
  overflow:hidden;
  cursor:pointer;
}

.day:hover{
  background:#ebebeb;
}

.today{
  outline:3px solid #2d837a;
}

.date-number{
  font-size:28px;
  font-weight:bold;
}

.hebrew-date{
  position:absolute;
  top:8px;
  left:10px;
  font-size:13px;
  opacity:0.6;
}

.event{
  font-size:15px;
  margin-top:8px;
  padding-top:6px;
  border-top:1px solid #ccc;
}

.ev-time{
  font-weight:bold;
}


/* --------- MODAL --------- */

#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
}

#modalContent{
  width:90%;
  max-width:700px;
  max-height:90vh;
  background:#ffffff;
  color:#000;
  border-radius:25px;
  padding:25px;
  overflow-y:auto;
  position:relative;
}

#closeModal{
  position:absolute;
  top:15px;
  left:20px;
  font-size:24px;
  cursor:pointer;
}

/* --------- MOBILE --------- */

@media (max-width: 800px){
  #calendar{ gap:5px; }
  .day{ min-height:90px; }
  .event{ display:none; }  /* на телефоне — только кратко, детально по клику */
  .date-number{ font-size:20px; }
  #monthLabel{ font-size:26px; }
}
</style>
</head>

<body>

<header>
  <img id="logo" src="https://www.gesher-theatre.co.il/images/logo.png">
  <div id="monthLabel"></div>
  <div id="clock">--:--</div>
</header>

<div class="weekdays">
  <div>א</div><div>ב</div><div>ג</div>
  <div>ד</div><div>ה</div><div>ו</div><div>ש</div>
</div>

<div id="calendar"></div>


<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
      <div id="closeModal">✕</div>
      <h2 id="modalDate"></h2>
      <div id="modalEvents"></div>
  </div>
</div>


<script>

/* === CONFIG === */

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8VHJ7usLuV213YvhCULcjqMrH6M22QQ_cLDtP8f6u0cb7XXKbeBVzEoKRGmigGFm_EQvtN17sQGi2/pub?output=csv";


/* === CLOCK === */

function updateClock(){
  const now = new Date();
  document.getElementById("clock").textContent =
    new Intl.DateTimeFormat("he-IL",
      {timeZone:"Asia/Jerusalem",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(now);
}
setInterval(updateClock,1000);
updateClock();



/* === HEBREW DATE === */

function getHebrewDate(date){
  return new Intl.DateTimeFormat('he-IL-u-ca-hebrew',{day:'numeric',month:'long'}).format(date);
}


/* === CSV PARSER === */

function parseCSV(text){
  const rows = [];
  let row = [], cell = "", insideQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];

    if(c === '"'){
      if(insideQuotes && n === '"'){ cell+='"'; i++; }
      else insideQuotes = !insideQuotes;
      continue;
    }

    if(c === ',' && !insideQuotes){
      row.push(cell.trim()); cell=""; continue;
    }

    if((c==='\n'||c==='\r') && !insideQuotes){
      if(cell || row.length){ row.push(cell.trim()); rows.push(row); }
      row=[]; cell="";
      continue;
    }

    cell+=c;
  }

  if(cell || row.length){ row.push(cell.trim()); rows.push(row); }

  return rows;
}


/* === UTIL === */

function split(text){
  if(!text) return [];
  return text.split(/\n|;/).map(t=>t.trim()).filter(Boolean);
}


/* === MAIN === */

let allEvents = [];

async function loadData(){

  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = parseCSV(text);

  const headers = rows[0];
  const col = (n) => headers.indexOf(n);

  const i = {
    date: col("תאריך"),
    title: col("שם ההצגה"),
    time: col("שעה"),
    place: col("מקום"),
    note: col("הערה"),
    limits: col("אילוצים"),
    ex_title: col("ההצגה חוצ"),
    ex_time: col("שעה חוצ"),
    ex_place: col("מקום חוצ")
  };

  allEvents = [];

  rows.slice(1).forEach(r=>{
    const date = r[i.date];
    if(!date) return;

    const titles = split(r[i.title]);
    const times  = split(r[i.time]);
    const places = split(r[i.place]);
    const notes  = split(r[i.note]);
    const limits = split(r[i.limits]);

    const max = Math.max(titles.length,times.length,places.length,notes.length,limits.length);

    for(let k=0;k<max;k++){
      allEvents.push({
        date,
        title: titles[k]||"",
        time: times[k]||"",
        place: places[k]||"",
        note: notes[k]||"",
        limits: limits[k]||""
      });
    }

    const exT = split(r[i.ex_title]);
    const exTi = split(r[i.ex_time]);
    const exP = split(r[i.ex_place]);
    const maxE = Math.max(exT.length,exTi.length,exP.length);

    for(let k=0;k<maxE;k++){
      if(!exT[k] && !exTi[k] && !exP[k]) continue;
      allEvents.push({
        date,
        title: "⭐ " + (exT[k]||""),
        time: exTi[k]||"",
        place: exP[k]||"",
        note:"",
        limits:"חוץ"
      });
    }

  });

  buildCalendar(new Date());
}


/* === CALENDAR === */

function buildCalendar(date){

  const cal = document.getElementById("calendar");
  cal.innerHTML="";

  const year = date.getFullYear();
  const month = date.getMonth();

  document.getElementById("monthLabel").textContent =
    new Intl.DateTimeFormat('he-IL',{month:'long',year:'numeric'}).format(date);

  const first = new Date(year,month,1);
  let start = first.getDay();
  if(start===0) start=7;

  const total = new Date(year,month+1,0).getDate();

  for(let i=1;i<start;i++) cal.appendChild(document.createElement("div"));

  for(let d=1;d<=total;d++){
    const dayDiv=document.createElement("div");
    dayDiv.className="day";

    const full = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const currentDate = new Date(year,month,d);

    dayDiv.innerHTML=`
      <div class="hebrew-date">${getHebrewDate(currentDate)}</div>
      <div class="date-number">${d}</div>
    `;

    const todays = allEvents.filter(e=>e.date===full);

    todays.forEach(e=>{
      const ev = document.createElement("div");
      ev.className="event";
      ev.innerHTML=`
        <div class="ev-time">${e.time}</div>
        <b>${e.title}</b>
        <div>${e.place}</div>
      `;
      dayDiv.appendChild(ev);
    });

    dayDiv.onclick=()=>openModal(currentDate, todays);

    cal.appendChild(dayDiv);
  }
}


/* === MODAL === */

function openModal(date, events){
  const modal = document.getElementById("modal");
  const eventsDiv = document.getElementById("modalEvents");

  document.getElementById("modalDate").textContent =
   new Intl.DateTimeFormat('he-IL',{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(date);

  eventsDiv.innerHTML="";

  if(!events.length){
    eventsDiv.innerHTML="<p>אין אירועים ביום זה</p>";
  }

  events.forEach(e=>{
    const div=document.createElement("div");
    div.innerHTML=`
      <h3>${e.title}</h3>
      <p>שעה: ${e.time}</p>
      <p>מקום: ${e.place}</p>
      ${e.note?`<p>${e.note}</p>`:""}
      ${e.limits?`<p>${e.limits}</p>`:""}
      <hr>
    `;
    eventsDiv.appendChild(div);
  });

  modal.style.display="flex";
}

document.getElementById("closeModal").onclick=()=>modal.style.display="none";
document.getElementById("modal").onclick=(e)=>{ if(e.target.id==="modal") modal.style.display="none"; }


/* === START === */

loadData();
setInterval(loadData,30000);

</script>

</body>
</html>